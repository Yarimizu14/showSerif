<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
</head>
<body>
  <!-- origin of words -->
  <div id="origin" style="display:none">
    <h1>
      ああああ              
      <p>
        いいい
        <span>
          ううう
          <span style="color:red">えええ</span>
          <span style="color:blue">おおお</span>
        </span>
        かかか
      </p>
      ききき
    </h1>
  </div>

  <!-- show words here -->
  <div id="target">
  </div>

  <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script>
    function showSerif(origin, target) {
      var timerId = null;
      var textQueue = [];

      var showNode = function($elem, textIndex) {
        textIndex = textIndex || 1;

        timerId = setTimeout(function() {
          if (!text) {
            return null;
          }
          if (text.length <= textIndex) {
            clearTimeout(timerId);
            timerId = null;
            next = textQueue.shift();
            if (next) showNode(next);
          } else {
            textIndex++
            //console.log("newTextNode", newTextElem.html());
            //$elem.repalceWith();
            $elem.text(text.substring(0, textIndex));
            //$elem.text(text.substring(0, textIndex));
            showNode($elem, textIndex);
          }
        }, 300);
      }

      /*
         parseDom
         @params {HTMLCollection} elem
         @params {jQuery Obj}     parent
       */
      var parseDom = function(elem, parent) {
        var $elem = $(elem);
        var contents = ($elem && $elem.contents) ? $elem.contents() : $elem; //returns jQuery Object

        if (contents && contents.length >= 1) {
          var $tag = $($("<div>").append($elem.clone().html("")).html());  //タグのみを取得
          parent.append($tag);
          textQueue.push($tag);
          return $.map(contents.get(), function(val) {
              return parseDom(val, $tag);
          });
        } else {
          var newTextElem = $("<div>").append($elem.clone());
          var text = $(elem).text().replace(/\s/g, "") ;
          newTextElem.data("text", text);
          parent.append($elem)
          textQueue.push($elem);
          if (!timerId) {
            showNode(textQueue.shift());
          };
          return elem;
        }
      }
      return parseDom(origin, $(target));
    }

    $(function() {
      console.log(showSerif($($("#origin").html()), $("#target")));
    });
  </script>
</body>
</html>
