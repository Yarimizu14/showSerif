<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title></title>
</head>
<body>
  <!-- origin of words -->
  <div id="origin" style="display:none">
    <h1>
      <p>
        いいい
        <span>
          ううう
          <span style="color:red">えええ</span>
          <span style="color:blue">おおお</span>
        </span>
        かかか
      </p>
      ききき
    </h1>
  </div>

  <!-- show words here -->
  <div id="target">
  </div>

  <script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
  <script>
    function showSerif(origin, target) {
      var timerId = null;
      var textQueue = [];

      var showNode = function($elem, textIndex) {
        textIndex = textIndex || 1;

        timerId = setTimeout(function() {
          if (!text) {
            return null;
          }
          if (text.length <= textIndex) {
            clearTimeout(timerId);
            timerId = null;
            next = textQueue.shift();
            if (next) showNode(next);
          } else {
            textIndex++
            $elem.text(text.substring(0, textIndex));
            showNode($elem, textIndex);
          }
        }, 300);
      }

      /*
         parseDom
         @params {HTMLCollection} elem
         @params {jQuery Obj}     parent
       */
      var parseDom = function(elem, parent) {
        var $elem = $(elem);
        var contents = ($elem && $elem.contents) ? $elem.contents() : $elem; //returns jQuery Object

        if (contents && contents.length >= 1) {
          var $tag = $($("<div>").append($elem.clone().html("")).html());  //タグのみを取得
          $tag.data("parent", parent); //親タグの情報を追加
          textQueue.push($tag);
          return $.map(contents.get(), function(val) {
              return parseDom(val, $tag);
          });
        } else {
          var text = $elem.text().replace(/\s/g, "") ;
          if (text) {
              var textContainer = $("<div>"); //textNodeを運ぶ仮のDivタグを作成(*textNodeのjQueryオブジェクトではdataメソッドを使用出来ない)
              textContainer.data("text", text);
              textContainer.data("parent", parent);
              textQueue.push(textContainer);
              if (!timerId) {
                //showNode(textQueue.shift());
              };
          }
          return elem;
        }
      }
      var tmp = parseDom(origin, $(target))
      for (var j=0, len=textQueue.length; j<len; j++) {
          var p = textQueue[j].data("parent");
          var t = textQueue[j].data("text");
          console.log($("<div>").append(textQueue[j]).html());
          if (p && p.append) {
              if (t || t === "") {
                p.append(t);
              } else {
                p.append(textQueue[j]);
              }
          }
      }
      return tmp;
    }

    $(function() {
      console.log(showSerif($($("#origin").html()), $("#target")));
    });
  </script>
</body>
</html>
